---
title: "outcome regression"
output: html_document
date: "2022-12-05"
---

```{r}
library(rstudioapi)
library(haven)
library(dplyr)
library(ggplot2)
library(readr)
library(measurements)
library(geosphere)
```


```{r}
path <- paste0(dirname(getSourceEditorContext()$path), '/data/raw/')
opts_knit$set(root.dir = path)

# load all relevant datasets
SSstation_cty_final <- read_csv("SSstation_cty_final.csv")
school_cutoffs <- read_dta("school_cutoffs.dta")

widths1980 <- c(4-1, 6-5, 14-7, 24-15, 26-25, 30-27, 0, 35-32, 45-36, 
                47-46, 0, 51-49, 0, 56-53, 0, 60-58, 0, 64-62, 67-65,
                72-68, 76-73, 78-77, 82-79, 0, 0, 86-85, 89-87, 91-90, 94-92, 0, 
                97-96, 100-98, 103-101, 0, 0)
widths1980 <- widths1980 + 1
# get vector of column names (taken from authors STATA code)
names1980 <- c('year', 'datanum', 'serial', 'hhwt', 'statefip', 'county', 'gq', 
               'pernum', 'perwt', 'momloc', 'sex', 'age', 'birthqtr', 'birthyr', 
               'race', 'raced', 'hispan', 'hispand', 'bpl', 'bpld', 'yrimmig', 
               'language', 'languaged', 'speakeng', 'school', 
               'higrade', 'higraded', 'educ', 'educd', 'gradeatt', 'gradeattd', 
               'migplac5', 'migcogrp', 'samemet5', 'migsamp')
# read in the data
census1980 <- read_fwf(file='census1980.dat', 
                       col_positions=fwf_widths(widths1980, names1980))



```

Columns we need to fit model 1:
- whether in preschool in 1969 (done: preschool1969 i.e. born in 1964-1968, I think)
- coverage rate of a kid's county (done)
    - for this, need to link counties in SSstation_cty_final (FIPS for state + county) with 1980 census
    - I think these are FIPS with a 0 at the end
    - Put in the predicted coverage given these FIPS codes
- policy (done: hsspend_at_four and fs_available)
    - HeadStart expenditures for kid at 4 and food stamps indicator for kid at 6
- outcome: grade-for-age status
    - TO DO: calculate
- state (done: st_fips)
- cohort (done: preschool1969 for model 1, I think)
- county (done: cfips90)

Basic exploration

```{r}
# # 106 county codes. Re-use same codes for different states? Texas alone has >250...
# length(unique(census1980$county))
# 
# # census uses 50 states + DC; only predict coverage in 49 states (in SSstation_cty_covs)
# length(unique(census1980$statefip))
# length(unique(SSstation_cty_final$stname))
# 
# # Comparing county codes
# sort(unique(census1980$county))
# sort(unique(SSstation_cty_final$ctyfips_hh))
# 
# colnames(census1980)
```


Basic subsetting
```{r}
# subset by birth year
census1980 <- filter(census1980, birthyr>=1959 & birthyr <= 1968)


# Subset to not include kids who moved from birth (?) state
# Don't have birth state in 1980 census I think, but migplac5 is state lived in in 1975
census1980$st_fips_1975 <- as.integer(census1980$migplac5)
census1980$st_fips <- as.integer(census1980$statefip)
census1980 <- filter(census1980, st_fips==st_fips_1975)

# Has to live in a state (between 1 and 56) in past and present
census1980 <- filter(census1980, st_fips_1975 >= 1 & st_fips_1975 <= 56)
census1980 <- filter(census1980, st_fips >= 1 & st_fips <= 56)

```


Put in each kid's Sesame Street coverage rate. Remove samples of counties with unknown coverage.

Pseudocode:
For each grouping of (ctyfips_hh, stfips_hh) in census1980:
  if it's in SSstation_cty_final, return its max_pred_cov. Else, return NA
Then join resulting vector into census1980 by (ctyfips_hh, stfips_hh) 



  
```{r}
census1980$cnty_fips <- as.integer(census1980$county)/10 # I think this is rightâ€¦

census_counties <- census1980 %>% 
  group_by(st_fips, cnty_fips) %>%
  select(st_fips, cnty_fips) %>%
  unique() %>% 
  ungroup()

census_counties$pred_cov <- sapply(1:nrow(census_counties), function(i) {
  row <- SSstation_cty_final %>%
    filter(stfips_hh==census_counties$st_fips[i]) %>%
    filter(ctyfips_hh==census_counties$cnty_fips[i])
  if (nrow(row)==1) {
    return(row[["max_pred_cov"]])
  } else {
    return(NA)
  }
})

# Add pred_cov by joining census_counties and census1980 on st_fips and cnty_fips
#df <- select(census1980, serial, cnty_fips, st_fips)
census1980 <- inner_join(census1980, census_counties, by = c("cnty_fips", "st_fips"))

# Subset to only include counties for which coverage is known
census1980 <- na.omit(census1980)


```

Put Food Stamp indicator in census1980. Did the kid at age 6 have access in the county to food stamps?

```{r}
fs_background <- read_dta('fs_background.dta') %>% 
  select(cnty_fips=countyfips, st_fips=stfips, fs_year)
census1980 <- inner_join(census1980, fs_background, by = c("cnty_fips", "st_fips"))

# For kid's county, was birth year + 6 >= year food stamps were introduced
census1980 <- census1980 %>% 
  group_by(cnty_fips, st_fips) %>% 
  mutate(fs_available = as.integer(birthyr + 6 >= fs_year)) %>%
  ungroup()

```


Put Head Start expenditures in census1980.

```{r}
hsspend <- read_dta("ludwig_miller_HSspend.dta")

# This dataset contains better FIPS coding (state and county column)
recode <- read_dta("ludwig_miller_fipsrecode.dta")
hsspend_df <- na.omit(inner_join(hsspend, recode, by="oldcode"))

hsspend_df <- hsspend_df %>%
  rename(hsspend68 = qje68) %>%
  rename(hsspend72 = qje72a) %>% # a used in .log
  mutate(hsspend69 = hsspend68 + (hsspend72-hsspend68)/4) %>%
  mutate(hsspend70 = hsspend68 + (hsspend72-hsspend68)/2) %>%
  mutate(hsspend71 = hsspend68 + 3*(hsspend72-hsspend68)/4) %>%
  rename(st_fips = state) %>%
  rename(cnty_fips = county) %>%
  select(-c("qje72b", "qje72c", "pop70", "oldcode"))

# Include HS expenditures in county for kid at age 4 in census dataset
# cfips90 column of census1980 is FIPS code of <state, county> combo
census1980 <- inner_join(census1980, hsspend_df, by = c("cnty_fips", "st_fips"))
census1980$hsspend_at_four <- rep(0, nrow(census1980))
idx <- which(census1980$birthyr==1964)
census1980$hsspend_at_four[idx] <- census1980$hsspend68[idx]
idx <- which(census1980$birthyr==1965)
census1980$hsspend_at_four[idx] <- census1980$hsspend69[idx]
idx <- which(census1980$birthyr==1966)
census1980$hsspend_at_four[idx] <- census1980$hsspend70[idx]
idx <- which(census1980$birthyr==1967)
census1980$hsspend_at_four[idx] <- census1980$hsspend71[idx]
idx <- which(census1980$birthyr==1968)
census1980$hsspend_at_four[idx] <- census1980$hsspend72[idx]


```

Birth Cohort for model 1: Whether kid was "preschool age" (<= 4) when SS began airing

```{r}
# Column for whether preschool age, per paper
census1980$preschool1969 <- as.integer(census1980$birthyr >= 1964)
```

Grade-for-age status
- In general the ages and grades really don't match up. The first people were born 21 years before 1980 but the highest grade observed is fifth.
    - e.g. the first few people are second graders who'd be 13 years old...
    - These seem much more like 1970 numbers! In 1970, only a few kids born between 1959 and 1968 would be old enough to be fifth graders, as we observe. 
```{r}
census1980$gradeatt[1:10] # highest attending
census1980$birthyr[1:10]
table(census1980$gradeatt)

```

